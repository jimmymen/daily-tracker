<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ä¸“å±æ—¥ç¨‹æ‰‹è´¦</title>
    <!-- å¼•å…¥æ‹–åŠ¨åº“ SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* === ğŸ¨ çš®è‚¤é…ç½® (é©¬å¡é¾™è‰²ç³») === */
        :root {
            --primary: #ff9a9e;       /* ä¸»è‰²ï¼šæ¨±èŠ±ç²‰ */
            --primary-dark: #ff6b6b;  /* æ·±ç²‰ */
            --accent: #84fab0;        /* è¾…è‰²ï¼šè–„è·ç»¿ */
            --bg: #fffcf5;            /* èƒŒæ™¯ï¼šæš–ç±³ç™½ */
            --text: #5e5e5e;          /* æ–‡å­—ï¼šæ·±ç° */
            --border: #ffe2e2;
            --done-bg: #f0fdf4;       /* å®Œæˆåçš„èƒŒæ™¯ */
            --shadow: 0 8px 20px rgba(255, 154, 158, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            min-height: 100vh;
            background-image: radial-gradient(#ffe2e2 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 100px; /* ç•™å‡ºåº•éƒ¨ç©ºé—´ */
        }

        /* === ğŸŒˆ é¡¶éƒ¨æ ‡é¢˜åŒº === */
        .header-card {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            color: white;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header-top-row {
            display: flex; justify-content: space-between; align-items: flex-start;
            position: relative; z-index: 2;
        }

        /* æ—¥å†æŒ‰é’® */
        .btn-calendar {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 8px 12px; border-radius: 12px;
            font-size: 1.2rem; cursor: pointer; backdrop-filter: blur(5px);
            transition: 0.2s;
        }
        .btn-calendar:active { transform: scale(0.95); background: rgba(255,255,255,0.4); }

        .title-area { flex: 1; }
        h1 { font-size: 1.6rem; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        
        .date-badge {
            background: rgba(255,255,255,0.25);
            padding: 4px 12px; border-radius: 20px;
            font-size: 0.85rem; display: inline-block;
            backdrop-filter: blur(5px); font-weight: bold;
        }

        /* å›åˆ°ä»Šå¤©æŒ‰é’® (é»˜è®¤éšè—) */
        .btn-today-return {
            display: none; margin-top: 10px;
            background: #fff; color: var(--primary-dark);
            border: none; padding: 5px 15px; border-radius: 20px;
            font-size: 0.8rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* === ğŸ“Š è¿›åº¦æ¡ === */
        .progress-container {
            background: white; padding: 15px 20px;
            border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 2px solid var(--border);
            display: flex; align-items: center; gap: 15px;
        }
        .progress-text { font-weight: bold; color: var(--primary-dark); font-size: 1.1rem; min-width: 50px; }
        .progress-bar-bg { flex: 1; height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .progress-bar-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* === âœ… ä»»åŠ¡åˆ—è¡¨ === */
        .task-list { display: flex; flex-direction: column; gap: 12px; min-height: 100px; }
        
        .task-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            border: 2px solid transparent;
            transition: all 0.4s ease; /* æµç•…åŠ¨ç”» */
            position: relative; overflow: hidden;
        }

        .sortable-ghost { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
        .drag-handle { color: #d1d5db; cursor: grab; padding: 5px; font-size: 1.2rem; display: flex; align-items: center; }
        
        .task-item.done { border-color: var(--accent); background: var(--done-bg); opacity: 0.85; }
        
        .check-box {
            width: 28px; height: 28px; border: 3px solid #ddd;
            border-radius: 50%; flex-shrink: 0;
            display: flex; justify-content: center; align-items: center;
            transition: 0.3s; cursor: pointer;
        }
        .task-item.done .check-box { background: var(--accent); border-color: var(--accent); transform: scale(1.1); }
        .check-box::after { content: 'âœ”'; color: white; font-weight: bold; font-size: 14px; display: none; }
        .task-item.done .check-box::after { display: block; }

        .task-text { flex: 1; font-size: 1.1rem; font-weight: 600; color: var(--text); transition: 0.3s; cursor: pointer; }
        .task-item.done .task-text { text-decoration: line-through; color: #aaa; }
        
        .btn-del {
            background: #ffe2e2; color: #ff6b6b; border: none;
            width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        /* === ğŸ“– å¿ƒå¾—æ—¥è®°åŒº === */
        .diary-section {
            background: white; border-radius: 16px; padding: 20px;
            border: 2px solid #fff4e6;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            position: relative;
        }
        .diary-title {
            font-size: 1rem; color: #ffbc7d; margin-bottom: 10px; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }
        .diary-input {
            width: 100%; height: 80px; border: none; outline: none;
            background: #fffcf5; padding: 10px; border-radius: 10px;
            font-size: 1rem; color: #666; resize: none;
            font-family: inherit; line-height: 1.5;
            background-image: linear-gradient(transparent 95%, #ffe2e2 95%);
            background-size: 100% 1.5rem; /* ä¿¡çº¸çº¿æ¡æ•ˆæœ */
        }
        .diary-input::placeholder { color: #dcdcdc; }

        /* === â• åº•éƒ¨æ·»åŠ æ  === */
        .add-area {
            background: white; padding: 10px; border-radius: 16px;
            display: flex; gap: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            border: 2px solid var(--border);
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 580px; z-index: 10;
        }
        .add-input {
            flex: 1; border: none; outline: none; padding: 10px;
            font-size: 1rem; border-radius: 10px; background: #fdfbf7; color: var(--text);
        }
        .btn-add {
            background: var(--primary); color: white;
            border: none; padding: 0 20px; border-radius: 12px;
            font-weight: bold; font-size: 1rem; cursor: pointer;
        }

        /* === ğŸ“… æ—¥å†å¼¹çª— === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 100; display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.2s;
        }
        .calendar-card {
            background: white; width: 90%; max-width: 380px;
            border-radius: 20px; padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s;
        }
        .cal-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .cal-title { font-size: 1.2rem; font-weight: bold; color: var(--text); }
        .cal-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-cell {
            padding: 8px 0; font-size: 0.9rem; border-radius: 50%; cursor: pointer; position: relative;
        }
        .cal-cell.today { background: #ffe2e2; color: var(--primary-dark); font-weight: bold; }
        .cal-cell.selected { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255,154,158,0.4); }
        .cal-cell.empty { pointer-events: none; }
        
        /* æ—¥å†ä¸Šçš„çŠ¶æ€ç‚¹ */
        .dot {
            width: 5px; height: 5px; border-radius: 50%;
            position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
        }
        .dot.green { background: #84fab0; } /* å…¨å®Œæˆ */
        .dot.orange { background: #ffbc7d; } /* æœªå®Œæˆ */

        /* èƒœåˆ©åŠ¨ç”» */
        .victory-modal-content { text-align: center; color: var(--text); padding: 20px; }
        .victory-emoji { font-size: 4rem; display: block; margin-bottom: 10px; animation: bounce 2s infinite; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .confetti { position: fixed; width: 10px; height: 10px; top: -10px; z-index: 99; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

    </style>
</head>
<body>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header-card">
            <div class="header-top-row">
                <div class="title-area">
                    <h1 id="appTitle">âœ¨ é—ªé—ªå‘å…‰çš„ä¸€å¤©</h1>
                    <div class="date-badge" id="dateDisplay">...</div>
                    <button id="btnBackToday" class="btn-today-return" onclick="goToToday()">ğŸ”™ å›åˆ°ä»Šå¤©</button>
                </div>
                <!-- æ—¥å†æŒ‰é’® -->
                <button class="btn-calendar" onclick="openCalendar()">ğŸ“…</button>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container">
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="task-list" id="taskList">
            <!-- JS æ¸²æŸ“å†…å®¹ -->
        </div>

        <!-- ğŸ“– å¿ƒå¾—æ—¥è®° -->
        <div class="diary-section">
            <div class="diary-title">ğŸ“ æ¯æ—¥å¿ƒå¾—</div>
            <textarea id="diaryInput" class="diary-input" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå¼€å¿ƒçš„äº‹ï¼Ÿå†™ä¸‹æ¥å§..." oninput="saveDiary()"></textarea>
        </div>
    </div>

    <!-- åº•éƒ¨æ·»åŠ æ  (åªæœ‰ä»Šå¤©æ˜¯å¯ç”¨çš„ï¼ŒæŸ¥çœ‹å†å²æ—¶éšè—æˆ–ç¦ç”¨) -->
    <div class="add-area" id="addArea">
        <input type="text" id="newTaskInput" class="add-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡...">
        <button class="btn-add" onclick="addTask()">æ·»åŠ </button>
    </div>

    <!-- ğŸ“… æ—¥å†å¼¹çª— -->
    <div class="modal-overlay" id="calendarModal" onclick="closeCalendar()">
        <div class="calendar-card" onclick="event.stopPropagation()">
            <div class="cal-header">
                <button class="cal-btn" onclick="changeMonth(-1)">â®</button>
                <div class="cal-title" id="calTitle">2023å¹´ 10æœˆ</div>
                <button class="cal-btn" onclick="changeMonth(1)">â¯</button>
            </div>
            <div class="cal-grid" style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>
    </div>

    <!-- ğŸ† èƒœåˆ©å¼¹çª— -->
    <div class="modal-overlay" id="victoryModal" onclick="closeVictory()">
        <div class="calendar-card victory-modal-content" onclick="event.stopPropagation()">
            <span class="victory-emoji">ğŸ‰</span>
            <h2 id="victoryTitle" style="color:#ff6b6b; margin-bottom:10px;">å¤ªæ£’å•¦ï¼</h2>
            <p id="victoryQuote" style="color:#666; margin-bottom:20px;">ä»»åŠ¡å…¨æå®šï¼</p>
            <button class="btn-add" style="width:100%" onclick="closeVictory()">æ”¶ä¸‹å¥–åŠ± ğŸ’–</button>
        </div>
    </div>

    <script>
        // === ğŸ› ï¸ æ ¸å¿ƒæ•°æ®ç®¡ç† ===
        const LS_KEY = 'sparkle_diary_data_v1';
        
        // é»˜è®¤ä»»åŠ¡æ¨¡ç‰ˆ
        const defaultTasks = [
            { id: 1, text: "è®¤çœŸåƒæ—©é¤ ğŸ¥›", done: false },
            { id: 2, text: "åœ¨å­¦æ ¡ä¸“å¿ƒå¬è®² ğŸ«", done: false },
            { id: 3, text: "å®Œæˆä»Šå¤©çš„ä½œä¸š ğŸ“š", done: false },
            { id: 4, text: "æ•´ç†è‡ªå·±çš„å°ä¹¦åŒ… ğŸ’", done: false },
            { id: 5, text: "æŒ‰æ—¶ç¡è§‰ä¸ç£¨è¹­ ğŸŒ™", done: false }
        ];

        // éšæœºæ ‡é¢˜åº“
        const titleList = ["âœ¨ é—ªé—ªå‘å…‰çš„ä¸€å¤©", "ğŸŒˆ æŠŠä»Šå¤©å˜æˆå½©è™¹è‰²", "ğŸš€ å¼€å¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©", "ğŸŒŸ ä»Šå¤©è¦å»æ”¶é›†æ˜Ÿæ˜Ÿ", "ğŸˆ å¿«ä¹å‡ºå‘ï¼GoGoï¼"];

        // å…¨å±€å˜é‡
        let allData = {}; // ç»“æ„: { "2023-10-20": { tasks: [], note: "" } }
        let viewDateStr = ""; // å½“å‰æ­£åœ¨æŸ¥é˜…çš„æ—¥æœŸ "YYYY-MM-DD"
        let todayStr = "";    // ä»Šå¤©çš„æ—¥æœŸ "YYYY-MM-DD"
        let sortableInstance = null;

        // æ—¥å†å˜é‡
        let calYear, calMonth; 

        // === ğŸš€ åˆå§‹åŒ– ===
        function init() {
            // 1. è¯»å–æœ¬åœ°æ€»æ•°æ®
            const saved = localStorage.getItem(LS_KEY);
            if (saved) {
                allData = JSON.parse(saved);
            }

            // 2. ç¡®å®šä»Šå¤©
            const now = new Date();
            todayStr = formatDateKey(now);
            viewDateStr = todayStr; // é»˜è®¤çœ‹ä»Šå¤©
            calYear = now.getFullYear();
            calMonth = now.getMonth();

            // 3. æ£€æŸ¥ä»Šå¤©æ˜¯å¦æœ‰æ•°æ®ï¼Œæ²¡æœ‰åˆ™åˆå§‹åŒ–
            if (!allData[todayStr]) {
                allData[todayStr] = {
                    tasks: JSON.parse(JSON.stringify(defaultTasks)),
                    note: ""
                };
                saveData();
            }

            // 4. è®¾ç½®éšæœºæ ‡é¢˜
            document.getElementById('appTitle').textContent = titleList[Math.floor(Math.random() * titleList.length)];

            renderView();
            initSortable();
        }

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // === ğŸ–¥ï¸ æ¸²æŸ“ä¸»ç•Œé¢ ===
        function renderView() {
            const data = allData[viewDateStr] || { tasks: [], note: "" };
            
            // 1. æ›´æ–°é¡¶éƒ¨æ—¥æœŸæ˜¾ç¤º
            const dateObj = new Date(viewDateStr);
            const dateText = dateObj.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('dateDisplay').textContent = dateText;

            // 2. æ§åˆ¶â€œå›åˆ°ä»Šå¤©â€æŒ‰é’®å’Œè¾“å…¥æ¡†
            const isToday = (viewDateStr === todayStr);
            document.getElementById('btnBackToday').style.display = isToday ? 'none' : 'inline-block';
            document.getElementById('addArea').style.display = isToday ? 'flex' : 'none'; // åªæœ‰ä»Šå¤©èƒ½åŠ ä»»åŠ¡
            
            // å†å²æ—¥è®°æ˜¯å¦åªè¯»ï¼Ÿè¿™é‡Œè®¾å®šä¸ºéšæ—¶å¯è¡¥å†™ï¼Œä¸ç¦ç”¨ textarea
            document.getElementById('diaryInput').value = data.note || "";

            // 3. æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';
            let doneCount = 0;
            
            data.tasks.forEach(task => {
                if(task.done) doneCount++;
                const div = document.createElement('div');
                div.className = `task-item ${task.done ? 'done' : ''}`;
                
                // åªæœ‰ä»Šå¤©æ‰èƒ½æ“ä½œåˆ é™¤/æ‹–åŠ¨/æ‰“é’©ï¼Œå†å²è®°å½•å»ºè®®åªè¯»ï¼Œæˆ–è€…ä½ å¯ä»¥æ”¾å¼€é™åˆ¶
                // ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œå…è®¸å†å²è¡¥æ‰“å¡ï¼Œä½†æ‹–åŠ¨åªåœ¨ä»Šå¤©å¼€å¯
                const isDrag = isToday ? '<div class="drag-handle">â‹®â‹®</div>' : '';
                const delBtn = isToday ? `<button class="btn-del" onclick="deleteTask(${task.id}, event)">ğŸ—‘ï¸</button>` : '';

                div.innerHTML = `
                    ${isDrag}
                    <div class="check-box" onclick="toggleTask(${task.id})"></div>
                    <div class="task-text" onclick="toggleTask(${task.id})">${task.text}</div>
                    ${delBtn}
                `;
                listEl.appendChild(div);
            });

            // 4. è¿›åº¦æ¡
            const total = data.tasks.length;
            const percent = total === 0 ? 0 : Math.round((doneCount / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';

            // 5. Sortable çŠ¶æ€
            if(sortableInstance) {
                sortableInstance.option("disabled", !isToday); // å†å²è®°å½•ä¸å¯æ‹–åŠ¨æ’åº
            }
        }

        // === ğŸ•¹ï¸ äº¤äº’é€»è¾‘ ===

        // åˆ‡æ¢ä»»åŠ¡çŠ¶æ€ (æ ¸å¿ƒä¸‹æ²‰é€»è¾‘)
        function toggleTask(id) {
            const data = allData[viewDateStr];
            const task = data.tasks.find(t => t.id === id);
            if (!task) return;

            task.done = !task.done;
            saveData();
            renderView(); // ç«‹å³åˆ·æ–°æ˜¾ç¤ºçŠ¶æ€

            // å»¶è¿Ÿæ‰§è¡Œæ’åºåŠ¨ç”»
            setTimeout(() => {
                const index = data.tasks.findIndex(t => t.id === id);
                if (index === -1) return;
                
                const [moved] = data.tasks.splice(index, 1);
                if (moved.done) {
                    data.tasks.push(moved); // å®Œæˆä¸‹æ²‰
                } else {
                    data.tasks.unshift(moved); // å–æ¶ˆç½®é¡¶
                }
                saveData();
                renderView();

                // åªæœ‰ä»Šå¤©ä¸”å…¨éƒ¨å®Œæˆæ—¶è§¦å‘åº†ç¥
                if (viewDateStr === todayStr && moved.done && data.tasks.every(t => t.done) && data.tasks.length > 0) {
                    showVictory();
                }
            }, 400);
        }

        function addTask() {
            const input = document.getElementById('newTaskInput');
            const val = input.value.trim();
            if (!val) return;
            
            allData[todayStr].tasks.unshift({ id: Date.now(), text: val, done: false });
            input.value = '';
            saveData();
            renderView();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteTask(id, event) {
            event.stopPropagation();
            if (confirm("åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ")) {
                allData[todayStr].tasks = allData[todayStr].tasks.filter(t => t.id !== id);
                saveData();
                renderView();
            }
        }

        function saveDiary() {
            const val = document.getElementById('diaryInput').value;
            if (!allData[viewDateStr]) {
                allData[viewDateStr] = { tasks: [], note: "" };
            }
            allData[viewDateStr].note = val;
            saveData();
        }

        function saveData() {
            localStorage.setItem(LS_KEY, JSON.stringify(allData));
        }

        function initSortable() {
            const el = document.getElementById('taskList');
            sortableInstance = new Sortable(el, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    if(viewDateStr !== todayStr) return; // åªæœ‰ä»Šå¤©èƒ½æ’åº
                    const item = allData[todayStr].tasks.splice(evt.oldIndex, 1)[0];
                    allData[todayStr].tasks.splice(evt.newIndex, 0, item);
                    saveData();
                }
            });
        }

        // === ğŸ“… æ—¥å†é€»è¾‘ ===
        function openCalendar() {
            document.getElementById('calendarModal').style.display = 'flex';
            renderCalendar();
        }
        function closeCalendar() {
            document.getElementById('calendarModal').style.display = 'none';
        }
        function changeMonth(delta) {
            calMonth += delta;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            document.getElementById('calTitle').textContent = `${calYear}å¹´ ${calMonth + 1}æœˆ`;
            grid.innerHTML = '';

            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

            // ç©ºç™½å¡«å……
            for (let i = 0; i < firstDay; i++) {
                const div = document.createElement('div');
                div.className = 'cal-cell empty';
                grid.appendChild(div);
            }

            // æ—¥æœŸç”Ÿæˆ
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div');
                div.className = 'cal-cell';
                div.textContent = d;

                // æ ·å¼åˆ¤æ–­
                if (dateKey === todayStr) div.classList.add('today');
                if (dateKey === viewDateStr) div.classList.add('selected');

                // æ•°æ®ç‚¹é€»è¾‘
                const dayData = allData[dateKey];
                if (dayData && dayData.tasks.length > 0) {
                    const allDone = dayData.tasks.every(t => t.done);
                    const dot = document.createElement('div');
                    dot.className = `dot ${allDone ? 'green' : 'orange'}`;
                    div.appendChild(dot);
                }

                div.onclick = () => {
                    viewDateStr = dateKey;
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æ²¡æœ‰æ•°æ®çš„æœªæ¥æˆ–è¿‡å»æŸå¤©ï¼Œæ˜¯å¦è¦åˆ›å»ºç©ºæ•°æ®ï¼Ÿ
                    // è¿™é‡Œä»…æ¸²æŸ“è§†å›¾ï¼Œå¦‚æœç”¨æˆ·å†™æ—¥è®°ä¼šè‡ªåŠ¨åˆ›å»ºæ•°æ®
                    closeCalendar();
                    renderView();
                };
                grid.appendChild(div);
            }
        }

        function goToToday() {
            viewDateStr = todayStr;
            renderView();
        }

        // === ğŸ‰ æ‚é¡¹ ===
        function showVictory() {
            const modal = document.getElementById('victoryModal');
            modal.style.display = 'flex';
            createConfetti();
        }
        function closeVictory() {
            document.getElementById('victoryModal').style.display = 'none';
            document.querySelectorAll('.confetti').forEach(el => el.remove());
        }
        function createConfetti() {
            const colors = ['#ff9a9e', '#a18cd1', '#fbc2eb', '#84fab0'];
            for (let i = 0; i < 50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random()*2+2)+'s';
                document.body.appendChild(c);
            }
        }

        document.getElementById('newTaskInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') addTask();
        });

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
