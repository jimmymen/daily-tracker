<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—ªé—ªæ‰‹è´¦ (ç»ˆææ•‘åŠ©ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --p: #ff9a9e; --pd: #ff6b6b; --ac: #84fab0; --bg: #fffcf5; --t: #5e5e5e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: sans-serif; background: var(--bg); color: var(--t); margin: 0; padding: 15px; padding-bottom: 100px; }
        .card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #ffe2e2; }
        
        /* é¡¶éƒ¨æ ·å¼ */
        .header { background: linear-gradient(135deg, #a18cd1, #fbc2eb); color: white; text-align: center; position: relative; }
        .date-str { font-size: 1.1rem; font-weight: bold; margin: 5px 0; }
        
        /* ä»»åŠ¡æ ·å¼ */
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #fef0f0; }
        .task-item.done { opacity: 0.6; }
        .task-item.done span { text-decoration: line-through; color: #ccc; }
        .box { width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%; flex-shrink: 0; cursor: pointer; }
        .done .box { background: var(--ac); border-color: var(--ac); }
        
        /* æ—¥è®°ä¸ç›¸å†Œ */
        textarea { width: 100%; height: 80px; border: 1px solid #fff4e6; background: #fffcf5; padding: 10px; border-radius: 10px; resize: none; }
        .photos { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .img-wrap { width: 60px; height: 60px; position: relative; border-radius: 5px; overflow: hidden; }
        .img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        /* åº•éƒ¨å·¥å…·æ  */
        .add-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid var(--p); outline: none; }
        .btn { background: var(--p); color: white; border: none; padding: 10px 15px; border-radius: 20px; font-weight: bold; }

        /* ç®¡ç†é¢æ¿ */
        .admin-panel { font-size: 0.8rem; background: #eee; color: #666; }
        .btn-mini { font-size: 0.7rem; padding: 3px 8px; margin: 2px; background: #ddd; border: none; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="card header">
        <div id="calBtn" onclick="openCal()" style="position:absolute; right:15px; cursor:pointer">ğŸ“…</div>
        <div class="date-str" id="dateDisplay">åŠ è½½ä¸­...</div>
        <div id="inheritBtn" style="display:none; color:yellow; font-size:0.8rem; text-decoration:underline; cursor:pointer" onclick="forceInherit()">å‘ç°å†å²å†…å®¹ï¼Œç‚¹å‡»åŒæ­¥</div>
    </div>

    <!-- ä»»åŠ¡åŒº -->
    <div class="card">
        <div id="taskList"></div>
        <div style="text-align: center; color: #ccc; font-size: 0.8rem; margin-top: 10px;" id="emptyTip">ä»Šå¤©è¿˜æ²¡æœ‰ä»»åŠ¡å“¦</div>
    </div>

    <!-- æ—¥è®°åŒº -->
    <div class="card">
        <textarea id="diaryInput" placeholder="ä»Šå¤©å¿ƒæƒ…æ€ä¹ˆæ ·ï¼Ÿ" oninput="saveData()"></textarea>
        <div class="photos" id="photoGallery">
            <label style="width:60px; height:60px; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#ccc;">
                + <input type="file" hidden accept="image/*" onchange="addImg(this)">
            </label>
        </div>
    </div>

    <!-- æ•°æ®æ•‘åŠ©ç«™ï¼ˆæ ¸å¿ƒæ–°å¢ï¼‰ -->
    <div class="card admin-panel">
        <strong>æ•°æ®æ•‘åŠ©ç«™ï¼š</strong><br>
        <button class="btn-mini" onclick="exportData()">å¤‡ä»½æ•°æ®(å¯¼å‡º)</button>
        <button class="btn-mini" onclick="importData()">æ¢å¤æ•°æ®(å¯¼å…¥)</button>
        <button class="btn-mini" onclick="clearPhotos()">æ¸…ç†ç…§ç‰‡(é‡Šç©ºé—´)</button>
        <div id="storageStatus" style="margin-top:5px; color:#999;"></div>
    </div>

    <div class="add-bar" id="addBar">
        <input type="text" id="taskIn" placeholder="å†™ä¸‹æ–°ç›®æ ‡...">
        <button class="btn" onclick="addTask()">æ·»åŠ </button>
    </div>

    <script>
        // å°è¯•å¯»æ‰¾æ‰€æœ‰å¯èƒ½çš„å†å²ç‰ˆæœ¬
        const KEYS = ['sparkle_diary_final', 'sparkle_diary_data_v1', 'sparkle_diary_v2', 'sparkle_data'];
        let activeKey = KEYS[0];
        let db = {};
        let today = new Date().toISOString().split('T')[0];
        let viewDate = today;

        function init() {
            // 1. æ·±åº¦æœç´¢å†å²è®°å½•
            KEYS.forEach(k => {
                let found = localStorage.getItem(k);
                if (found) {
                    let parsed = JSON.parse(found);
                    db = { ...db, ...parsed }; // åˆå¹¶æ‰€æœ‰å†å²ç‰ˆæœ¬çš„æ•°æ®
                }
            });

            // 2. åˆå§‹åŒ–ä»Šå¤©
            if (!db[today]) {
                db[today] = { tasks: [], note: "", photos: [] };
                checkInherit(); // åªæœ‰ä»Šå¤©æ²¡æ•°æ®æ—¶æ‰æ£€æŸ¥ç»§æ‰¿
            }

            updateStorageInfo();
            render();
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å†å²å¯ä»¥ç»§æ‰¿
        function checkInherit() {
            let pastDates = Object.keys(db).filter(d => d < today && db[d].tasks && db[d].tasks.length > 0);
            if (pastDates.length > 0) {
                document.getElementById('inheritBtn').style.display = 'block';
            }
        }

        // å¼ºåˆ¶ç»§æ‰¿æœ€åä¸€æ¬¡çš„å†…å®¹
        function forceInherit() {
            let pastDates = Object.keys(db).filter(d => d < today && db[d].tasks && db[d].tasks.length > 0).sort();
            if (pastDates.length > 0) {
                let lastDate = pastDates[pastDates.length - 1];
                db[today].tasks = db[lastDate].tasks.map(t => ({ id: Date.now()+Math.random(), text: t.text, done: false }));
                saveData();
                render();
                document.getElementById('inheritBtn').style.display = 'none';
            }
        }

        function render() {
            let data = db[viewDate] || { tasks: [], note: "", photos: [] };
            document.getElementById('dateDisplay').textContent = viewDate;
            document.getElementById('addBar').style.display = (viewDate === today) ? 'flex' : 'none';

            // ä»»åŠ¡æ¸²æŸ“
            let list = document.getElementById('taskList');
            list.innerHTML = '';
            document.getElementById('emptyTip').style.display = data.tasks.length ? 'none' : 'block';
            data.tasks.forEach(t => {
                let div = document.createElement('div');
                div.className = `task-item ${t.done ? 'done' : ''}`;
                div.innerHTML = `<div class="box" onclick="toggle(${t.id})"></div><span style="flex:1" onclick="toggle(${t.id})">${t.text}</span>`;
                if(viewDate === today) div.innerHTML += `<div onclick="delTask(${t.id})" style="color:#ff9a9e">âœ•</div>`;
                list.appendChild(div);
            });

            // æ—¥è®°ç›¸å†Œ
            document.getElementById('diaryInput').value = data.note || "";
            let gallery = document.getElementById('photoGallery');
            let addBtn = gallery.querySelector('label');
            gallery.innerHTML = '';
            (data.photos || []).forEach((p, i) => {
                let w = document.createElement('div');
                w.className = 'img-wrap';
                w.innerHTML = `<img src="${p}">${viewDate===today ? `<div onclick="delImg(${i})" style="position:absolute;top:0;right:0;background:red;color:white;padding:2px">âœ•</div>`:''}`;
                gallery.appendChild(w);
            });
            if(viewDate === today) gallery.appendChild(addBtn);
        }

        // åŸºç¡€æ“ä½œ
        function addTask() {
            let input = document.getElementById('taskIn');
            if (!input.value) return;
            db[today].tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            saveData(); render();
        }
        function toggle(id) {
            let t = db[viewDate].tasks.find(x => x.id === id);
            if (t) t.done = !t.done;
            saveData(); render();
        }
        function delTask(id) {
            db[today].tasks = db[today].tasks.filter(x => x.id !== id);
            saveData(); render();
        }
        function addImg(input) {
            let file = input.files[0];
            let reader = new FileReader();
            reader.onload = (e) => {
                let img = new Image();
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if(w > 400) { h *= 400/w; w = 400; } // å¼ºåŠ›å‹ç¼©é˜²æ­¢å­˜æ»¡
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    db[today].photos.push(canvas.toDataURL('image/jpeg', 0.5));
                    saveData(); render();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        function delImg(i) { db[today].photos.splice(i,1); saveData(); render(); }
        function saveData() {
            db[viewDate].note = document.getElementById('diaryInput').value;
            localStorage.setItem(activeKey, JSON.stringify(db));
            updateStorageInfo();
        }

        //æ•‘åŠ©åŠŸèƒ½
        function exportData() {
            let str = JSON.stringify(db);
            let blob = new Blob([str], {type: "text/plain"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement("a");
            a.href = url;
            a.download = "é—ªé—ªæ‰‹è´¦å¤‡ä»½.txt";
            a.click();
            alert("å·²ä¸‹è½½å¤‡ä»½æ–‡ä»¶ï¼Œè¯·ä¿å­˜å¥½ï¼");
        }
        function importData() {
            let val = prompt("è¯·ç²˜è´´å¯¼å‡ºçš„å¤‡ä»½å†…å®¹ï¼ˆæˆ–è€…é€‰æ‹©æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ›´ä½³ï¼Œæ­¤å¤„æš‚ç”¨æ–‡æœ¬ï¼‰");
            if (val) {
                try {
                    db = JSON.parse(val);
                    saveData(); render();
                    alert("æ¢å¤æˆåŠŸï¼");
                } catch(e) { alert("æ ¼å¼ä¸å¯¹å“¦"); }
            }
        }
        function clearPhotos() {
            if (confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ—¥æœŸçš„ç…§ç‰‡å—ï¼Ÿè¿™å°†è…¾å‡ºå¤§é‡å­˜å‚¨ç©ºé—´ï¼")) {
                Object.keys(db).forEach(d => db[d].photos = []);
                saveData(); render();
            }
        }
        function updateStorageInfo() {
            let used = JSON.stringify(db).length;
            document.getElementById('storageStatus').textContent = `å·²ç”¨ç©ºé—´: ${(used/1024).toFixed(1)} KB / çº¦5000 KB`;
        }
        function openCal() {
            let date = prompt("è¯·è¾“å…¥æ—¥æœŸ (å¦‚ 2023-10-27)", viewDate);
            if (date && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                viewDate = date; render();
            }
        }

        init();
    </script>
</body>
</html>
