<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é—ªé—ªæ‰‹è´¦ (æ•°æ®ç»ˆæå…¼å®¹ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #ff9a9e; --primary-dark: #ff6b6b;
            --accent: #84fab0; --bg: #fffcf5;
            --text: #5e5e5e; --border: #ffe2e2;
            --done-bg: #f0fdf4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "PingFang SC", sans-serif; background: var(--bg); color: var(--text);
            padding: 20px; min-height: 100vh; line-height: 1.6;
        }
        .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; padding-bottom: 120px; }

        /* é¡¶éƒ¨è£…é¥° */
        .header-card {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 20px; padding: 20px; text-align: center; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); position: relative;
        }
        .btn-cal { position: absolute; right: 15px; top: 15px; background: rgba(255,255,255,0.3); border: none; padding: 8px; border-radius: 12px; cursor: pointer; font-size: 1.2rem; }
        .date-badge { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; font-size: 0.9rem; display: inline-block; margin-top: 5px; }

        /* ä»»åŠ¡é¡¹ */
        .task-list { display: flex; flex-direction: column; gap: 10px; }
        .task-item {
            background: white; border-radius: 15px; padding: 12px 15px; display: flex; align-items: center; gap: 12px;
            border: 2px solid transparent; transition: 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .task-item.done { background: var(--done-bg); border-color: var(--accent); opacity: 0.8; }
        .check-box { width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 50%; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .task-item.done .check-box { background: var(--accent); border-color: var(--accent); }
        .check-box::after { content: 'âœ”'; color: white; font-size: 12px; display: none; }
        .task-item.done .check-box::after { display: block; }
        .task-text { flex: 1; font-weight: 600; font-size: 1rem; }
        .task-item.done .task-text { text-decoration: line-through; color: #aaa; }
        
        /* ç»§æ‰¿æé†’æŒ‰é’® (ä»…åœ¨æœ‰å†å²å¯ç»§æ‰¿æ—¶æ˜¾ç¤º) */
        #inheritTip {
            background: #fff4e6; color: #ff922b; padding: 10px; border-radius: 12px;
            font-size: 0.85rem; text-align: center; cursor: pointer; border: 1px dashed #ffad72; display: none;
        }

        /* æ—¥è®°ä¸ç›¸å†Œ */
        .diary-section { background: white; border-radius: 18px; padding: 15px; border: 2px solid #fff4e6; }
        .diary-input {
            width: 100%; height: 100px; border: none; outline: none; background: #fffcf5;
            padding: 10px; border-radius: 10px; font-size: 0.95rem; resize: none;
            background-image: linear-gradient(transparent 95%, #ffe2e2 95%); background-size: 100% 1.6rem;
        }
        .photo-gallery { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .photo-item { width: 70px; height: 70px; border-radius: 8px; position: relative; border: 1px solid #eee; }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 7px; }
        .photo-del { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; border: none; width: 18px; height: 18px; font-size: 10px; }
        .btn-add-photo { width: 70px; height: 70px; border-radius: 8px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #ccc; cursor: pointer; }

        /* åº•éƒ¨ */
        .add-area {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; background: white; padding: 8px; border-radius: 50px;
            display: flex; gap: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); border: 2px solid var(--border);
        }
        .add-input { flex: 1; border: none; outline: none; padding-left: 20px; font-size: 1rem; background: transparent; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* æ—¥å†å¼¹çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 350px; border-radius: 20px; padding: 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .cal-cell { padding: 8px 0; border-radius: 10px; cursor: pointer; position: relative; font-size: 0.9rem; }
        .cal-cell.has-data::after { content: ''; width: 4px; height: 4px; background: var(--primary); border-radius: 50%; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); }
        .cal-cell.today { background: #fff0f0; color: var(--primary-dark); font-weight: bold; }
        .cal-cell.selected { background: var(--primary) !important; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card">
            <h1 id="appTitle">âœ¨ æˆ‘çš„é—ªäº®æ‰‹è´¦</h1>
            <div class="date-badge" id="dateDisplay">åŠ è½½ä¸­...</div>
            <button class="btn-cal" onclick="toggleModal('calModal', true)">ğŸ“…</button>
            <div id="btnBackToday" style="display:none; font-size:0.8rem; margin-top:10px; cursor:pointer; text-decoration:underline;" onclick="goToToday()">è¿”å›ä»Šå¤©</div>
        </div>

        <!-- å¼ºåˆ¶ç»§æ‰¿æç¤º -->
        <div id="inheritTip" onclick="forceInherit()">ğŸ’¡ å‘ç°å†å²ä»»åŠ¡ï¼Œç‚¹å‡»è¿™é‡ŒåŒæ­¥åˆ°ä»Šå¤©</div>

        <div class="task-list" id="taskList"></div>

        <div class="diary-section">
            <textarea id="diaryInput" class="diary-input" placeholder="è®°ä¸‹ä»Šæ—¥è¶£äº‹..." oninput="saveData()"></textarea>
            <div class="photo-gallery" id="photoGallery">
                <label class="btn-add-photo" id="btnAddPhoto">
                    <span>+</span>
                    <input type="file" hidden accept="image/*" onchange="uploadPhoto(this)">
                </label>
            </div>
        </div>
    </div>

    <div class="add-area" id="addArea">
        <input type="text" id="newTaskInput" class="add-input" placeholder="å†™ä¸‹æ–°ä»»åŠ¡...">
        <button class="btn-add" onclick="addTask()">æ·»åŠ </button>
    </div>

    <!-- æ—¥å†å¼¹çª— -->
    <div class="modal" id="calModal" onclick="toggleModal('calModal', false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                <button onclick="changeMonth(-1)" style="border:none;background:none;cursor:pointer;">â®</button>
                <span id="calTitle"></span>
                <button onclick="changeMonth(1)" style="border:none;background:none;cursor:pointer;">â¯</button>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒé…ç½®ï¼šå°è¯•æ‰«ææ‰€æœ‰å¯èƒ½çš„å†å² Key
        const CURRENT_KEY = 'sparkle_diary_final';
        const OLD_KEYS = ['sparkle_diary_data_v1', 'sparkle_diary_v2', 'sparkle_data'];
        
        let allData = {};
        let todayStr = getFormatDate(new Date());
        let viewDateStr = todayStr;
        let calDate = new Date();

        // 1. åˆå§‹åŒ–ä¸æ•°æ®åˆå¹¶
        function init() {
            // é¦–å…ˆå°è¯•è¯»å–ä¸» Key
            let localData = localStorage.getItem(CURRENT_KEY);
            if (localData) {
                allData = JSON.parse(localData);
            }

            // æ•°æ®è¿ç§»é€»è¾‘ï¼šå¦‚æœä¸» Key æ²¡æ•°æ®ï¼Œå»æ—§ Key é‡Œæ‰¾
            OLD_KEYS.forEach(oldKey => {
                let oldData = localStorage.getItem(oldKey);
                if (oldData) {
                    let parsedOld = JSON.parse(oldData);
                    // åˆå¹¶æ—§æ•°æ®åˆ°æ–°å¯¹è±¡ä¸­ï¼ˆä¸è¦†ç›–å·²å­˜åœ¨çš„ï¼‰
                    allData = { ...parsedOld, ...allData };
                }
            });

            // å¦‚æœä»Šå¤©æ²¡æ•°æ®ï¼Œæ˜¾ç¤ºç»§æ‰¿æç¤º
            checkInheritTip();

            if (!allData[todayStr]) {
                // é»˜è®¤åˆå§‹åŒ–ä»Šå¤©
                allData[todayStr] = { tasks: [], note: "", photos: [] };
            }

            render();
            initSortable();
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºâ€œç»§æ‰¿ä»»åŠ¡â€çš„æç¤º
        function checkInheritTip() {
            const historyDates = Object.keys(allData).sort();
            const pastDates = historyDates.filter(d => d < todayStr);
            
            // å¦‚æœä»Šå¤©ä»»åŠ¡ä¸ºç©ºï¼Œä¸”è¿‡å»æœ‰ä»»åŠ¡ï¼Œåˆ™æ˜¾ç¤ºæç¤º
            if (pastDates.length > 0 && (!allData[todayStr] || allData[todayStr].tasks.length === 0)) {
                document.getElementById('inheritTip').style.display = 'block';
            } else {
                document.getElementById('inheritTip').style.display = 'none';
            }
        }

        // å¼ºåˆ¶ç»§æ‰¿ï¼šæ‰‹åŠ¨æŠŠæœ€è¿‘çš„ä¸€å¤©åŒæ­¥è¿‡æ¥
        function forceInherit() {
            const historyDates = Object.keys(allData).sort();
            const pastDates = historyDates.filter(d => d < todayStr);
            if (pastDates.length > 0) {
                const lastDate = pastDates[pastDates.length - 1];
                allData[todayStr].tasks = allData[lastDate].tasks.map(t => ({
                    id: Date.now() + Math.random(),
                    text: t.text,
                    done: false
                }));
                saveData();
                render();
                document.getElementById('inheritTip').style.display = 'none';
                alert("å·²åŒæ­¥æœ€è¿‘ä¸€æ¬¡ä»»åŠ¡å†…å®¹ï¼");
            }
        }

        // æ¸²æŸ“é¡µé¢
        function render() {
            const data = allData[viewDateStr] || { tasks: [], note: "", photos: [] };
            const isToday = (viewDateStr === todayStr);

            // æ—¥æœŸæ ‡é¢˜
            document.getElementById('dateDisplay').textContent = viewDateStr === todayStr ? `ä»Šå¤© ${viewDateStr}` : viewDateStr;
            document.getElementById('btnBackToday').style.display = isToday ? 'none' : 'block';
            document.getElementById('addArea').style.display = isToday ? 'flex' : 'none';

            // ä»»åŠ¡åˆ—è¡¨
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            data.tasks.forEach(t => {
                const div = document.createElement('div');
                div.className = `task-item ${t.done ? 'done' : ''}`;
                div.innerHTML = `
                    <div class="check-box" onclick="toggleTask(${t.id})"></div>
                    <div class="task-text" onclick="toggleTask(${t.id})">${t.text}</div>
                    ${isToday ? `<button style="border:none;background:none;color:#ff9a9e;cursor:pointer;" onclick="delTask(${t.id})">âœ•</button>` : ''}
                `;
                list.appendChild(div);
            });

            // æ—¥è®°ç›¸å†Œ
            document.getElementById('diaryInput').value = data.note || "";
            const gallery = document.getElementById('photoGallery');
            const addBtn = document.getElementById('btnAddPhoto');
            gallery.innerHTML = '';
            (data.photos || []).forEach((img, idx) => {
                const d = document.createElement('div');
                d.className = 'photo-item';
                d.innerHTML = `<img src="${img}">${isToday ? `<button class="photo-del" onclick="delPhoto(${idx})">Ã—</button>` : ''}`;
                gallery.appendChild(d);
            });
            if(isToday) gallery.appendChild(addBtn);
        }

        // åŸºç¡€æ“ä½œ
        function addTask() {
            const input = document.getElementById('newTaskInput');
            if(!input.value) return;
            allData[todayStr].tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            saveData();
            render();
        }

        function toggleTask(id) {
            const tasks = allData[viewDateStr].tasks;
            const t = tasks.find(x => x.id === id);
            if(t) t.done = !t.done;
            saveData();
            render();
        }

        function delTask(id) {
            allData[todayStr].tasks = allData[todayStr].tasks.filter(x => x.id !== id);
            saveData();
            render();
        }

        function uploadPhoto(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if(w > 600) { h *= 600/w; w = 600; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    if(!allData[todayStr].photos) allData[todayStr].photos = [];
                    allData[todayStr].photos.push(canvas.toDataURL('image/jpeg', 0.6));
                    saveData();
                    render();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function delPhoto(idx) {
            allData[todayStr].photos.splice(idx, 1);
            saveData();
            render();
        }

        function saveData() {
            allData[viewDateStr].note = document.getElementById('diaryInput').value;
            localStorage.setItem(CURRENT_KEY, JSON.stringify(allData));
        }

        // æ—¥å†æ ¸å¿ƒé€»è¾‘
        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            const title = document.getElementById('calTitle');
            grid.innerHTML = '<div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>';
            
            const year = calDate.getFullYear();
            const month = calDate.getMonth();
            title.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const days = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=days; d++) {
                const dateKey = getFormatDate(new Date(year, month, d));
                const cell = document.createElement('div');
                cell.className = `cal-cell ${dateKey === todayStr ? 'today' : ''} ${dateKey === viewDateStr ? 'selected' : ''}`;
                if(allData[dateKey] && (allData[dateKey].tasks.length > 0 || allData[dateKey].note)) {
                    cell.classList.add('has-data');
                }
                cell.textContent = d;
                cell.onclick = () => { viewDateStr = dateKey; toggleModal('calModal', false); render(); };
                grid.appendChild(cell);
            }
        }

        // å·¥å…·å‡½æ•°
        function getFormatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        }
        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
            if(show) renderCalendar();
        }
        function changeMonth(step) {
            calDate.setMonth(calDate.getMonth() + step);
            renderCalendar();
        }
        function goToToday() {
            viewDateStr = todayStr;
            render();
        }
        function initSortable() {
            new Sortable(document.getElementById('taskList'), {
                animation: 150,
                onEnd: () => {
                    // æ’åºåæ›´æ–°æ•°ç»„é¡ºåº
                    const names = Array.from(document.querySelectorAll('.task-text')).map(el => el.textContent);
                    const newTasks = names.map(name => allData[todayStr].tasks.find(t => t.text === name));
                    allData[todayStr].tasks = newTasks;
                    saveData();
                }
            });
        }

        init();
    </script>
</body>
</html>
