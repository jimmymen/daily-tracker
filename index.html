<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ä¸“å±æ—¥ç¨‹æ‰‹è´¦ (ç»ˆæå…¼å®¹ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* === ğŸ¨ è¿˜åŸé©¬å¡é¾™ç»å…¸çš®è‚¤ === */
        :root {
            --primary: #ff9a9e;       --primary-dark: #ff6b6b;
            --accent: #84fab0;        --bg: #fffcf5;
            --text: #5e5e5e;          --border: #ffe2e2;
            --done-bg: #f0fdf4;       --shadow: 0 8px 20px rgba(255, 154, 158, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh;
            background-image: radial-gradient(#ffe2e2 1px, transparent 1px); background-size: 20px 20px;
        }

        .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 120px; }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .header-card {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 20px; padding: 25px 20px; text-align: center; color: white; box-shadow: var(--shadow); position: relative;
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .btn-calendar { background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 8px 12px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; backdrop-filter: blur(5px); }
        .date-badge { background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; display: inline-block; font-weight: bold; margin-top: 5px; }

        /* å¼ºåˆ¶ç»§æ‰¿æé†’ */
        #inheritAlert {
            display: none; background: #fff4e6; color: #ff922b; padding: 12px; border-radius: 15px;
            text-align: center; font-size: 0.9rem; font-weight: bold; border: 2px dashed #ffbc7d; cursor: pointer; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }

        /* ä»»åŠ¡é¡¹ */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item {
            background: white; border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 2px solid transparent; transition: 0.3s;
        }
        .task-item.done { border-color: var(--accent); background: var(--done-bg); opacity: 0.8; }
        .check-box { width: 28px; height: 28px; border: 3px solid #ddd; border-radius: 50%; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .task-item.done .check-box { background: var(--accent); border-color: var(--accent); }
        .check-box::after { content: 'âœ”'; color: white; font-weight: bold; display: none; }
        .task-item.done .check-box::after { display: block; }
        .task-text { flex: 1; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .task-item.done .task-text { text-decoration: line-through; color: #aaa; }

        /* æ—¥è®°ç›¸å†Œ */
        .diary-section { background: white; border-radius: 16px; padding: 20px; border: 2px solid #fff4e6; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .diary-input {
            width: 100%; height: 80px; border: none; outline: none; background: #fffcf5; padding: 10px; border-radius: 10px;
            font-size: 1rem; color: #666; resize: none; line-height: 1.5; background-image: linear-gradient(transparent 95%, #ffe2e2 95%); background-size: 100% 1.5rem;
        }
        .photo-gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .img-item { width: 70px; height: 70px; border-radius: 10px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .img-item img { width: 100%; height: 100%; object-fit: cover; }
        .btn-add-img { width: 70px; height: 70px; border-radius: 10px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 1.5rem; cursor: pointer; }

        /* åº•éƒ¨æ·»åŠ æ  */
        .add-area {
            background: white; padding: 10px; border-radius: 50px; display: flex; gap: 10px;
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 580px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 2px solid var(--border);
        }
        .add-input { flex: 1; border: none; outline: none; padding-left: 20px; font-size: 1rem; background: transparent; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; }

        /* æ—¥å†å¼¹çª— */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-card { background: white; width: 90%; max-width: 380px; border-radius: 20px; padding: 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .cal-cell { padding: 10px 0; border-radius: 10px; cursor: pointer; position: relative; font-size: 0.9rem; }
        .cal-cell.today { background: #ffe2e2; color: var(--primary-dark); font-weight: bold; }
        .cal-cell.selected { background: var(--primary); color: white; }
        .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--primary); position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); }

        /* ç®¡ç†é¢æ¿ (åº•éƒ¨éšè—) */
        .debug-panel { margin-top: 20px; padding: 10px; background: #eee; border-radius: 10px; font-size: 0.7rem; color: #999; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card">
            <div class="header-top-row">
                <div style="text-align:left">
                    <h1 id="appTitle">âœ¨ é—ªé—ªå‘å…‰çš„ä¸€å¤©</h1>
                    <div class="date-badge" id="dateDisplay">åŠ è½½æ—¥æœŸä¸­...</div>
                </div>
                <button class="btn-calendar" onclick="toggleModal(true)">ğŸ“…</button>
            </div>
            <div id="btnBackToday" style="display:none; margin-top:10px; cursor:pointer; text-decoration:underline; font-size:0.8rem;" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
        </div>

        <!-- æ•‘å‘½æŒ‰é’®ï¼šç»§æ‰¿å†å² -->
        <div id="inheritAlert" onclick="forceInherit()">
            ğŸ’¡ å‘ç°ä½ ä¹‹å‰çš„ä»»åŠ¡è®°å½•ï¼Œç‚¹å‡»è¿™é‡ŒåŒæ­¥åˆ°ä»Šå¤©
        </div>

        <div class="task-list" id="taskList"></div>

        <div class="diary-section">
            <textarea id="diaryInput" class="diary-input" placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆå¥½äº‹ï¼Ÿ" oninput="autoSave()"></textarea>
            <div class="photo-gallery" id="photoGallery">
                <label class="btn-add-img" id="btnAddImg">
                    + <input type="file" hidden accept="image/*" onchange="uploadImg(this)">
                </label>
            </div>
        </div>

        <!-- è°ƒè¯•é¢æ¿ (ç”¨æ¥ç¡®è®¤æ•°æ®åœ¨ä¸åœ¨) -->
        <div class="debug-panel">
            æ•°æ®çŠ¶æ€ï¼š<span id="dataStatus">æ£€æŸ¥ä¸­...</span> | 
            <span onclick="exportData()" style="text-decoration:underline;cursor:pointer">å¤‡ä»½æ•°æ®</span>
        </div>
    </div>

    <div class="add-area" id="addArea">
        <input type="text" id="newTaskInput" class="add-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡...">
        <button class="btn-add" onclick="addTask()">æ·»åŠ </button>
    </div>

    <!-- æ—¥å†å¼¹çª— -->
    <div class="modal" id="calModal" onclick="toggleModal(false)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:center; font-weight:bold;">
                <button onclick="moveMonth(-1)" style="border:none;background:none;cursor:pointer">â®</button>
                <div id="calMonthTitle"></div>
                <button onclick="moveMonth(1)" style="border:none;background:none;cursor:pointer">â¯</button>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>
    </div>

    <script>
        // 1. ç»ˆææ•°æ®å…¼å®¹åˆ—è¡¨ (åŒ…å«ä½ ä¹‹å‰æ‰€æœ‰å¯èƒ½ç”¨è¿‡çš„åå­—)
        const OLD_KEYS = ['sparkle_diary_data_v1', 'sparkle_diary_final', 'sparkle_diary_v2', 'sparkle_data', 'sparkle_diary_data_v3'];
        const MAIN_KEY = 'sparkle_diary_master'; // ä»¥åç»Ÿä¸€ç”¨è¿™ä¸ª
        
        let db = {};
        let today = new Date().toLocaleDateString('en-CA'); // è·å– YYYY-MM-DD
        let viewDate = today;
        let calCursor = new Date();

        // 2. åˆå§‹åŒ–ï¼šæ•°æ®æœæ•‘
        function init() {
            // ä»ä¸»åº“è¯»å–
            let master = localStorage.getItem(MAIN_KEY);
            if (master) db = JSON.parse(master);

            // æœæ•‘æ—§åº“æ•°æ®å¹¶åˆå¹¶
            OLD_KEYS.forEach(key => {
                let old = localStorage.getItem(key);
                if (old) {
                    let parsedOld = JSON.parse(old);
                    db = { ...parsedOld, ...db }; // æ—§æ•°æ®è¡¥å…¨åˆ°ä¸»åº“
                }
            });

            // çŠ¶æ€æ˜¾ç¤º
            const historyCount = Object.keys(db).length;
            document.getElementById('dataStatus').textContent = `å·²æ‰¾åˆ° ${historyCount} å¤©çš„å†å²è®°å½•`;

            // åˆå§‹åŒ–ä»Šå¤©
            if (!db[today]) {
                db[today] = { tasks: [], note: "", photos: [] };
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç»§æ‰¿
                showInheritIfAvailable();
            }

            render();
            initSortable();
        }

        // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šå¼ºåˆ¶ç»§æ‰¿
        function showInheritIfAvailable() {
            const dates = Object.keys(db).filter(d => d < today).sort();
            if (dates.length > 0 && db[today].tasks.length === 0) {
                document.getElementById('inheritAlert').style.display = 'block';
            }
        }

        function forceInherit() {
            const dates = Object.keys(db).filter(d => d < today).sort();
            if (dates.length > 0) {
                const lastDate = dates[dates.length - 1];
                db[today].tasks = db[lastDate].tasks.map(t => ({
                    id: Date.now() + Math.random(),
                    text: t.text,
                    done: false
                }));
                save();
                render();
                document.getElementById('inheritAlert').style.display = 'none';
            }
        }

        // 4. é¡µé¢æ¸²æŸ“
        function render() {
            const data = db[viewDate] || { tasks: [], note: "", photos: [] };
            const isToday = (viewDate === today);

            // é¡¶éƒ¨ä¿¡æ¯
            document.getElementById('dateDisplay').textContent = (viewDate === today ? "ä»Šå¤© " : "") + viewDate;
            document.getElementById('btnBackToday').style.display = isToday ? 'none' : 'block';
            document.getElementById('addArea').style.display = isToday ? 'flex' : 'none';

            // ä»»åŠ¡æ¸²æŸ“
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            data.tasks.forEach(t => {
                const div = document.createElement('div');
                div.className = `task-item ${t.done ? 'done' : ''}`;
                div.innerHTML = `
                    <div class="check-box" onclick="toggleTask(${t.id})"></div>
                    <div class="task-text" onclick="toggleTask(${t.id})">${t.text}</div>
                    ${isToday ? `<span onclick="delTask(${t.id})" style="color:#ff9a9e;cursor:pointer">âœ•</span>` : ''}
                `;
                list.appendChild(div);
            });

            // æ—¥è®°æ¸²æŸ“
            document.getElementById('diaryInput').value = data.note || "";
            
            // ç›¸å†Œæ¸²æŸ“
            const gallery = document.getElementById('photoGallery');
            const addBtn = document.getElementById('btnAddImg');
            gallery.innerHTML = '';
            (data.photos || []).forEach((img, idx) => {
                const d = document.createElement('div');
                d.className = 'img-item';
                d.innerHTML = `<img src="${img}">${isToday ? `<div onclick="delImg(${idx})" style="position:absolute;top:0;right:0;background:red;color:white;font-size:10px;padding:2px;cursor:pointer">âœ•</div>` : ''}`;
                gallery.appendChild(d);
            });
            if(isToday) gallery.appendChild(addBtn);
        }

        // 5. äº¤äº’é€»è¾‘
        function addTask() {
            const input = document.getElementById('newTaskInput');
            if (!input.value.trim()) return;
            db[today].tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            save(); render();
        }

        function toggleTask(id) {
            const t = db[viewDate].tasks.find(x => x.id === id);
            if (t) t.done = !t.done;
            save(); render();
        }

        function delTask(id) {
            db[today].tasks = db[today].tasks.filter(x => x.id !== id);
            save(); render();
        }

        function uploadImg(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if(w > 500) { h *= 500/w; w = 500; }
                    cvs.width = w; cvs.height = h;
                    cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                    if(!db[today].photos) db[today].photos = [];
                    db[today].photos.push(cvs.toDataURL('image/jpeg', 0.6));
                    save(); render();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function delImg(idx) {
            db[today].photos.splice(idx, 1);
            save(); render();
        }

        function autoSave() {
            db[viewDate].note = document.getElementById('diaryInput').value;
            save();
        }

        function save() {
            localStorage.setItem(MAIN_KEY, JSON.stringify(db));
        }

        // 6. æ—¥å†é€»è¾‘
        function toggleModal(show) {
            document.getElementById('calModal').style.display = show ? 'flex' : 'none';
            if(show) renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            const title = document.getElementById('calMonthTitle');
            grid.innerHTML = '<div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>';
            
            const year = calCursor.getFullYear();
            const month = calCursor.getMonth();
            title.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const days = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=days; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = `cal-cell ${dateKey === today ? 'today' : ''} ${dateKey === viewDate ? 'selected' : ''}`;
                if(db[dateKey] && (db[dateKey].tasks.length > 0 || db[dateKey].note)) {
                    const dot = document.createElement('div'); dot.className = 'dot'; cell.appendChild(dot);
                }
                cell.innerHTML += d;
                cell.onclick = () => { viewDate = dateKey; toggleModal(false); render(); };
                grid.appendChild(cell);
            }
        }

        function moveMonth(delta) {
            calCursor.setMonth(calCursor.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() { viewDate = today; render(); }

        function exportData() {
            prompt("è¯·å¤åˆ¶ä»¥ä¸‹ä»£ç å¹¶ä¿å­˜åˆ°è®°äº‹æœ¬ä¸­ï¼Œè¿™æ˜¯ä½ çš„æ‰€æœ‰æ•°æ®ï¼š", JSON.stringify(db));
        }

        function initSortable() {
            new Sortable(document.getElementById('taskList'), {
                animation: 150, onEnd: () => {
                    const list = [];
                    document.querySelectorAll('.task-text').forEach(el => {
                        const t = db[viewDate].tasks.find(x => x.text === el.textContent);
                        if(t) list.push(t);
                    });
                    db[viewDate].tasks = list;
                    save();
                }
            });
        }

        // å¯åŠ¨ï¼
        init();

    </script>
</body>
</html>
