<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„ä¸“å±æ—¥ç¨‹æ‰‹è´¦ (æ™ºæ…§å½±åƒç‰ˆ)</title>
    <!-- å¼•å…¥æ‹–åŠ¨åº“ SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* === ğŸ¨ çš®è‚¤ä¸æ ·å¼ (ä¿ç•™é©¬å¡é¾™è‰²ç³») === */
        :root {
            --primary: #ff9a9e;       --primary-dark: #ff6b6b;
            --accent: #84fab0;        --bg: #fffcf5;
            --text: #5e5e5e;          --border: #ffe2e2;
            --done-bg: #f0fdf4;       --shadow: 0 8px 20px rgba(255, 154, 158, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh;
            background-image: radial-gradient(#ffe2e2 1px, transparent 1px); background-size: 20px 20px;
        }

        .container { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 120px; }

        /* é¡¶éƒ¨å¡ç‰‡ */
        .header-card {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            border-radius: 20px; padding: 25px 20px; text-align: center; color: white; box-shadow: var(--shadow);
        }
        .header-top-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .btn-calendar {
            background: rgba(255,255,255,0.25); border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 8px 12px; border-radius: 12px; font-size: 1.2rem; cursor: pointer;
        }
        .date-badge { background: rgba(255,255,255,0.25); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .btn-today-return {
            background: #fff; color: var(--primary-dark); border: none; padding: 5px 15px; 
            border-radius: 20px; font-size: 0.8rem; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            background: white; padding: 15px 20px; border-radius: 16px; border: 2px solid var(--border);
            display: flex; align-items: center; gap: 15px;
        }
        .progress-bar-bg { flex: 1; height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e, #fad0c4); transition: width 0.5s ease; }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item {
            background: white; border-radius: 16px; padding: 15px; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); border: 2px solid transparent; transition: 0.3s;
        }
        .task-item.done { border-color: var(--accent); background: var(--done-bg); }
        .check-box { width: 26px; height: 26px; border: 2px solid #ddd; border-radius: 50%; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .task-item.done .check-box { background: var(--accent); border-color: var(--accent); }
        .check-box::after { content: 'âœ”'; color: white; font-size: 14px; display: none; }
        .task-item.done .check-box::after { display: block; }
        .task-text { flex: 1; font-size: 1.05rem; font-weight: 600; cursor: pointer; }
        .task-item.done .task-text { text-decoration: line-through; color: #aaa; }
        .btn-del { background: #ffe2e2; color: #ff6b6b; border: none; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; }

        /* æ—¥è®°ä¸ç›¸å†Œ */
        .diary-section { background: white; border-radius: 16px; padding: 20px; border: 2px solid #fff4e6; }
        .diary-input {
            width: 100%; height: 80px; border: none; outline: none; background: #fffcf5; padding: 10px;
            border-radius: 10px; font-size: 1rem; resize: none; line-height: 1.5;
            background-image: linear-gradient(transparent 95%, #ffe2e2 95%); background-size: 100% 1.5rem;
        }
        .photo-gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .photo-item { width: 80px; height: 80px; border-radius: 10px; position: relative; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .photo-del { position: absolute; top: -5px; right: -5px; background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; }
        .btn-add-photo { width: 80px; height: 80px; border-radius: 10px; border: 2px dashed #ddd; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #aaa; font-size: 0.7rem; cursor: pointer; }

        /* åº•éƒ¨æ·»åŠ  */
        .add-area {
            background: white; padding: 10px; border-radius: 16px; display: flex; gap: 10px;
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 580px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border: 2px solid var(--border);
        }
        .add-input { flex: 1; border: none; outline: none; padding: 10px; font-size: 1rem; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* æ—¥å†å¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 100; display: none; justify-content: center; align-items: center; }
        .calendar-card { background: white; width: 90%; max-width: 380px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-weight: bold; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .cal-weekday { font-size: 0.75rem; color: #999; padding-bottom: 5px; }
        .cal-cell { padding: 10px 0; font-size: 0.9rem; border-radius: 10px; cursor: pointer; position: relative; transition: 0.2s; }
        .cal-cell:hover { background: #fef0f0; }
        .cal-cell.today { color: var(--primary-dark); font-weight: bold; background: #fff0f0; }
        .cal-cell.selected { background: var(--primary) !important; color: white !important; }
        .dot { width: 5px; height: 5px; border-radius: 50%; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); }
        .dot.green { background: #84fab0; }
        .dot.orange { background: #ffbc7d; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-card">
            <div class="header-top-row">
                <div style="flex:1">
                    <h1 id="appTitle">âœ¨ é—ªé—ªå‘å…‰çš„ä¸€å¤©</h1>
                    <div class="date-badge" id="dateDisplay">åŠ è½½ä¸­...</div><br>
                    <button id="btnBackToday" class="btn-today-return" onclick="goToToday()" style="display:none">ğŸ”™ è¿”å›ä»Šå¤©</button>
                </div>
                <button class="btn-calendar" onclick="openCalendar()">ğŸ“…</button>
            </div>
        </div>

        <div class="progress-container">
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <div class="task-list" id="taskList"></div>

        <div class="diary-section">
            <div style="font-size:0.9rem; color:#ffbc7d; font-weight:bold; margin-bottom:10px">ğŸ“ æ¯æ—¥å¿ƒå¾— & å½±åƒ</div>
            <textarea id="diaryInput" class="diary-input" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿«ä¹..." oninput="saveDiary()"></textarea>
            <div class="photo-gallery" id="photoGallery">
                <label class="btn-add-photo" id="btnAddPhoto">
                    <span>ğŸ“·</span><span>å­˜ä¸ªçºªå¿µ</span>
                    <input type="file" id="imageInput" accept="image/*" hidden onchange="uploadPhoto(this)">
                </label>
            </div>
        </div>
    </div>

    <div class="add-area" id="addArea">
        <input type="text" id="newTaskInput" class="add-input" placeholder="æ·»åŠ æ–°ä»»åŠ¡...">
        <button class="btn-add" onclick="addTask()">æ·»åŠ </button>
    </div>

    <!-- æ—¥å†å¼¹çª— -->
    <div class="modal-overlay" id="calendarModal" onclick="closeCalendar()">
        <div class="calendar-card" onclick="event.stopPropagation()">
            <div class="cal-header">
                <button onclick="changeMonth(-1)" style="border:none;background:none;cursor:pointer">â®</button>
                <div id="calTitle"></div>
                <button onclick="changeMonth(1)" style="border:none;background:none;cursor:pointer">â¯</button>
            </div>
            <div class="cal-grid" id="calWeekdayGrid">
                <div class="cal-weekday">æ—¥</div><div class="cal-weekday">ä¸€</div><div class="cal-weekday">äºŒ</div>
                <div class="cal-weekday">ä¸‰</div><div class="cal-weekday">å››</div><div class="cal-weekday">äº”</div>
                <div class="cal-weekday">å…­</div>
            </div>
            <div class="cal-grid" id="calGrid"></div>
        </div>
    </div>

    <script>
        const LS_KEY = 'sparkle_diary_data_v1';
        let allData = {}; 
        let viewDateStr = ""; 
        let todayStr = "";    
        let calYear, calMonth; 

        // 1. åˆå§‹åŒ–
        function init() {
            const saved = localStorage.getItem(LS_KEY);
            if (saved) allData = JSON.parse(saved);

            const now = new Date();
            todayStr = formatDateKey(now);
            viewDateStr = todayStr;
            calYear = now.getFullYear();
            calMonth = now.getMonth();

            // æ™ºèƒ½ç»§æ‰¿ï¼šå¦‚æœä»Šå¤©æ²¡æ•°æ®ï¼Œæ‰¾â€œæœ€è¿‘çš„æœ‰æ•°æ®çš„ä¸€å¤©â€
            if (!allData[todayStr]) {
                allData[todayStr] = { 
                    tasks: getTasksFromMostRecentHistory(), 
                    note: "", 
                    photos: [] 
                };
                saveData();
            }

            renderView();
            initSortable();
        }

        /**
         * ğŸ§¬ å¢å¼ºç‰ˆç»§æ‰¿ç®—æ³•
         * é€»è¾‘ï¼šä¸åªæ˜¯æ‰¾æ˜¨å¤©ï¼Œè€Œæ˜¯éå†æ‰€æœ‰å†å²ï¼Œæ‰¾åˆ°ç¦»ä»Šå¤©æœ€è¿‘çš„é‚£ä¸€å¤©
         */
        function getTasksFromMostRecentHistory() {
            const dates = Object.keys(allData).sort(); // å‡åºæ’åˆ—æ‰€æœ‰æ—¥æœŸ
            const pastDates = dates.filter(d => d < todayStr); // è¿‡æ»¤å‡ºä»Šå¤©ä¹‹å‰çš„

            if (pastDates.length === 0) {
                // å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œå®Œå…¨æ²¡å†å²ï¼Œç»™é»˜è®¤æ¨¡ç‰ˆ
                return [
                    { id: 1, text: "è®¤çœŸåƒæ—©é¤ ğŸ¥›", done: false },
                    { id: 2, text: "æŒ‰æ—¶ç¡è§‰ ğŸŒ™", done: false }
                ];
            }

            // æ‹¿åˆ°æœ€è¿‘çš„ä¸€å¤©ï¼ˆæ•°ç»„æœ€åä¸€ä¸ªï¼‰
            const lastDateKey = pastDates[pastDates.length - 1];
            const lastDayData = allData[lastDateKey];

            console.log(`æ™ºèƒ½ç»§æ‰¿ï¼šä» ${lastDateKey} ç»§æ‰¿äº†ä»»åŠ¡å†…å®¹`);

            // è¿”å›è¯¥å¤©çš„ä»»åŠ¡å†…å®¹ï¼Œä½†é‡ç½® done çŠ¶æ€
            return lastDayData.tasks.map(t => ({
                id: Date.now() + Math.random(), // é‡æ–°åˆ†é…IDé˜²æ­¢å†²çª
                text: t.text,
                done: false
            }));
        }

        // 2. æ¸²æŸ“ä¸»ç•Œé¢
        function renderView() {
            const data = allData[viewDateStr] || { tasks: [], note: "", photos: [] };
            const isToday = (viewDateStr === todayStr);

            // æ ‡é¢˜ä¸æ—¥æœŸ
            const d = new Date(viewDateStr);
            document.getElementById('dateDisplay').textContent = d.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('btnBackToday').style.display = isToday ? 'none' : 'inline-block';
            document.getElementById('addArea').style.display = isToday ? 'flex' : 'none';
            document.getElementById('btnAddPhoto').style.display = isToday ? 'flex' : 'none';

            // æ—¥è®°ä¸ç…§ç‰‡
            document.getElementById('diaryInput').value = data.note || "";
            const gallery = document.getElementById('photoGallery');
            const addBtn = document.getElementById('btnAddPhoto');
            gallery.innerHTML = '';
            (data.photos || []).forEach((pic, idx) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `<img src="${pic}">${isToday ? `<button class="photo-del" onclick="deletePhoto(${idx})">Ã—</button>` : ''}`;
                gallery.appendChild(div);
            });
            gallery.appendChild(addBtn);

            // ä»»åŠ¡åˆ—è¡¨
            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';
            let doneCount = 0;
            (data.tasks || []).forEach(t => {
                if(t.done) doneCount++;
                const div = document.createElement('div');
                div.className = `task-item ${t.done ? 'done' : ''}`;
                div.innerHTML = `
                    <div class="check-box" onclick="toggleTask(${t.id})"></div>
                    <div class="task-text" onclick="toggleTask(${t.id})">${t.text}</div>
                    ${isToday ? `<button class="btn-del" onclick="deleteTask(${t.id}, event)">ğŸ—‘ï¸</button>` : ''}
                `;
                listEl.appendChild(div);
            });

            const percent = data.tasks.length ? Math.round((doneCount / data.tasks.length) * 100) : 0;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }

        // 3. æ ¸å¿ƒåŠŸèƒ½
        function toggleTask(id) {
            if (viewDateStr !== todayStr) return;
            const task = allData[todayStr].tasks.find(t => t.id === id);
            if (task) {
                task.done = !task.done;
                saveData();
                renderView();
            }
        }

        function addTask() {
            const input = document.getElementById('newTaskInput');
            if (!input.value.trim()) return;
            allData[todayStr].tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            saveData();
            renderView();
        }

        function deleteTask(id, e) {
            e.stopPropagation();
            allData[todayStr].tasks = allData[todayStr].tasks.filter(t => t.id !== id);
            saveData();
            renderView();
        }

        function uploadPhoto(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > 800) { h *= 800/w; w = 800; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    if (!allData[viewDateStr].photos) allData[viewDateStr].photos = [];
                    allData[viewDateStr].photos.push(canvas.toDataURL('image/jpeg', 0.7));
                    saveData(); renderView();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function deletePhoto(idx) {
            allData[viewDateStr].photos.splice(idx, 1);
            saveData(); renderView();
        }

        function saveDiary() {
            allData[viewDateStr].note = document.getElementById('diaryInput').value;
            saveData();
        }

        function saveData() { localStorage.setItem(LS_KEY, JSON.stringify(allData)); }

        // 4. æ—¥å†é€»è¾‘ (ä¿®å¤æ˜¾ç¤ºé—®é¢˜)
        function openCalendar() {
            document.getElementById('calendarModal').style.display = 'flex';
            renderCalendar();
        }

        function closeCalendar() { document.getElementById('calendarModal').style.display = 'none'; }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            document.getElementById('calTitle').textContent = `${calYear}å¹´ ${calMonth + 1}æœˆ`;
            grid.innerHTML = ''; // æ¸…ç©ºæ—¥æœŸæ ¼

            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

            // å¡«å……ç©ºç™½
            for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement('div'));

            // å¡«å……æ—¥æœŸ
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const cell = document.createElement('div');
                cell.className = 'cal-cell';
                if (dateKey === todayStr) cell.classList.add('today');
                if (dateKey === viewDateStr) cell.classList.add('selected');
                cell.textContent = d;

                // å†å²æ•°æ®æ‰“ç‚¹
                const dayData = allData[dateKey];
                if (dayData && dayData.tasks && dayData.tasks.length > 0) {
                    const dot = document.createElement('div');
                    const allDone = dayData.tasks.every(t => t.done);
                    dot.className = `dot ${allDone ? 'green' : 'orange'}`;
                    cell.appendChild(dot);
                }

                cell.onclick = () => { viewDateStr = dateKey; renderView(); closeCalendar(); };
                grid.appendChild(cell);
            }
        }

        function changeMonth(delta) {
            calMonth += delta;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            else if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }

        function goToToday() { viewDateStr = todayStr; renderView(); }

        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
        }

        function initSortable() {
            new Sortable(document.getElementById('taskList'), {
                animation: 150,
                onEnd: () => {
                    const list = [];
                    document.querySelectorAll('.task-text').forEach(el => {
                        const t = allData[todayStr].tasks.find(x => x.text === el.textContent);
                        if(t) list.push(t);
                    });
                    allData[todayStr].tasks = list;
                    saveData();
                }
            });
        }

        init();
    </script>
</body>
</html>
