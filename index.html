<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ—¥ç¨‹è¡¨ - æ ¸å¿ƒç‰ˆ</title>
    <style>
        :root {
            --primary: #2563eb; --bg: #f8fafc; --card: #ffffff;
            --text: #1e293b; --border: #e2e8f0;
        }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* åŸºç¡€ç»„ä»¶ */
        .card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        
        /* AI è¾“å…¥åŒº */
        textarea { width: 100%; height: 80px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; resize: none; }
        .ai-status { font-size: 0.85rem; color: #64748b; margin-top: 5px; }

        /* æ—¥å†æ ·å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .cal-day { border: 1px solid var(--border); min-height: 80px; padding: 5px; font-size: 0.8rem; background: #fff; }
        .cal-header { text-align: center; font-weight: bold; padding: 10px 0; }
        .event-tag { background: #dbeafe; color: #1e40af; padding: 2px 4px; border-radius: 3px; margin-top: 2px; font-size: 0.7rem; overflow: hidden; }

        /* ç™»å½•å± */
        #loginScreen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

    <!-- ç™»å½•æ¨¡å— -->
    <div id="loginScreen">
        <h1>AI Calendar</h1>
        <button class="btn btn-primary" onclick="login()">Google è´¦å·ç™»å½•</button>
    </div>

    <div id="app" class="container" style="display: none;">
        <div class="header">
            <h2 id="userName">æˆ‘çš„æ—¥ç¨‹</h2>
            <div>
                <input type="password" id="apiKey" placeholder="DeepSeek API Key" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <button class="btn" onclick="logout()">é€€å‡º</button>
            </div>
        </div>

        <!-- AI å½•å…¥åŒº -->
        <section class="card">
            <h3>âœ¨ æ™ºèƒ½å½•å…¥</h3>
            <textarea id="aiInput" placeholder="ç›´æ¥è¾“å…¥ï¼Œä¾‹å¦‚ï¼šæ˜å¤©ä¸‹åˆ2ç‚¹åœ¨å’–å•¡å…å¼€ä¼šï¼ŒæŒç»­ä¸€å°æ—¶..."></textarea>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span id="aiStatus" class="ai-status">æ”¯æŒè‡ªç„¶è¯­è¨€è¯†åˆ«æ—¥æœŸã€æ—¶é—´å’Œæ—¶é•¿</span>
                <button class="btn btn-primary" id="aiBtn" onclick="processAI()">AI è¯†åˆ«å¹¶æ·»åŠ </button>
            </div>
        </section>

        <!-- æ—¥å†æ˜¾ç¤ºåŒº -->
        <section class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="currentMonth">2023å¹´10æœˆ</h3>
                <input type="month" id="monthPicker" onchange="renderCalendar()">
            </div>
            <div class="calendar-grid" id="calHeader"></div>
            <div class="calendar-grid" id="calGrid"></div>
        </section>

        <!-- åˆ—è¡¨åŒº -->
        <section class="card">
            <h3>ğŸ“… è¿‘æœŸåˆ—è¡¨</h3>
            <div id="eventList"></div>
        </section>
    </div>

    <script type="module">
        // --- 1. Firebase åˆå§‹åŒ– (è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„é…ç½®) ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "ä½ çš„API_KEY",
            authDomain: "ä½ çš„åŸŸå.firebaseapp.com",
            projectId: "ä½ çš„é¡¹ç›®ID",
            storageBucket: "ä½ çš„å­˜å‚¨æ¡¶.appspot.com",
            messagingSenderId: "å‘é€è€…ID",
            appId: "APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allEvents = [];

        // --- 2. ç”¨æˆ·è®¤è¯é€»è¾‘ ---
        window.login = () => signInWithPopup(auth, provider);
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('userName').innerText = `${user.displayName} çš„æ—¥ç¨‹`;
                document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7);
                
                // åŠ è½½æœ¬åœ°ä¿å­˜çš„ API Key
                if(localStorage.getItem('cal_api_key')) document.getElementById('apiKey').value = localStorage.getItem('cal_api_key');

                // å®æ—¶ç›‘å¬æ•°æ®åº“
                const q = query(collection(db, `users/${user.uid}/events`), orderBy("date", "asc"));
                onSnapshot(q, (snap) => {
                    allEvents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderAll();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        // --- 3. AI æ ¸å¿ƒè¯†åˆ«é€»è¾‘ ---
        window.processAI = async () => {
            const text = document.getElementById('aiInput').value.trim();
            const key = document.getElementById('apiKey').value.trim();
            if(!text || !key) return alert("è¯·è¾“å…¥å†…å®¹å’Œ API Key");
            
            localStorage.setItem('cal_api_key', key);
            const btn = document.getElementById('aiBtn');
            const status = document.getElementById('aiStatus');
            
            btn.disabled = true;
            status.innerText = "âš¡ AI æ­£åœ¨æ€è€ƒ...";

            // æ„å»º Prompt
            const today = new Date().toISOString().split('T')[0];
            const prompt = `
                ä½ æ˜¯ä¸€ä¸ªæ—¥ç¨‹åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·çš„æè¿°è½¬æ¢ä¸º JSON æ ¼å¼ã€‚
                å½“å‰çš„æ—¥æœŸæ˜¯ ${today}ã€‚
                è¿”å›æ ¼å¼ï¼š{"title": "äº‹ä»¶åç§°", "date": "YYYY-MM-DD", "time": "HH:MM", "duration": "åˆ†é’Ÿæ•°", "desc": "è¯¦æƒ…"}
                ç”¨æˆ·è¾“å…¥: "${text}"
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{ role: "system", content: "ä½ åªè¾“å‡ºçº¯ JSONï¼Œä¸è¾“å‡ºä»»ä½•è§£é‡Šã€‚" }, { role: "user", content: prompt }],
                        response_format: { type: "json_object" }
                    })
                });

                const data = await res.json();
                const eventData = JSON.parse(data.choices[0].message.content);
                
                // ä¿å­˜åˆ° Firebase
                await addDoc(collection(db, `users/${currentUser.uid}/events`), {
                    ...eventData,
                    createdAt: new Date()
                });

                document.getElementById('aiInput').value = "";
                status.innerText = "âœ… å·²æˆåŠŸæ·»åŠ è‡³æ—¥ç¨‹";
            } catch (e) {
                console.error(e);
                alert("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ");
            } finally {
                btn.disabled = false;
            }
        };

        // --- 4. ç•Œé¢æ¸²æŸ“é€»è¾‘ ---
        function renderAll() {
            renderCalendar();
            renderList();
        }

        function renderCalendar() {
            const grid = document.getElementById('calGrid');
            const header = document.getElementById('calHeader');
            const monthVal = document.getElementById('monthPicker').value;
            const [y, m] = monthVal.split('-').map(Number);
            
            grid.innerHTML = '';
            header.innerHTML = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => `<div class="cal-header">${d}</div>`).join('');
            
            const firstDay = new Date(y, m-1, 1).getDay();
            const daysInMonth = new Date(y, m, 0).getDate();

            // å¡«å……ç©ºç™½
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            // å¡«å……æ—¥æœŸ
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayEvents = allEvents.filter(e => e.date === dateStr);
                
                let eventHtml = dayEvents.map(e => `<div class="event-tag">${e.time || ''} ${e.title}</div>`).join('');
                grid.innerHTML += `<div class="cal-day"><strong>${d}</strong>${eventHtml}</div>`;
            }
        }

        function renderList() {
            const list = document.getElementById('eventList');
            if(allEvents.length === 0) { list.innerHTML = "æš‚æ— æ—¥ç¨‹"; return; }
            
            list.innerHTML = allEvents.map(e => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0; display:flex; justify-content:space-between;">
                    <div>
                        <b style="color:var(--primary)">${e.date} ${e.time || ''}</b> - ${e.title}
                        <div style="font-size: 0.8rem; color: #666;">${e.desc || ''}</div>
                    </div>
                    <button onclick="deleteEvent('${e.id}')" style="color:red; border:none; background:none; cursor:pointer;">åˆ é™¤</button>
                </div>
            `).join('');
        }

        window.deleteEvent = async (id) => {
            if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/events`, id));
            }
        };

    </script>
</body>
</html>
