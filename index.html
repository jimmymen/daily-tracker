<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™ºèƒ½æ—¥ç¨‹è¡¨</title>
    <style>
        :root {
            --primary: #2563eb; --primary-dark: #1e40af; 
            --bg: #f8fafc; --card: #ffffff; --text: #334155; --border: #cbd5e1;
            --success: #16a34a; --danger: #dc2626;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text); padding: 15px; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-bottom: 40px; }

        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { font-size: 1.1rem; font-weight: 700; color: #0f172a; }
        .card-body { padding: 20px; }

        /* é¡¶éƒ¨æ  */
        .top-bar { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 16px 24px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(37,99,235,0.3); }
        .user-pill { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; backdrop-filter: blur(4px); }

        /* AI è¾“å…¥åŒº */
        .ai-box { position: relative; border: 2px dashed var(--border); border-radius: 12px; padding: 10px; background: #f8fafc; transition: 0.3s; }
        .ai-box:focus-within { border-color: var(--primary); background: #fff; }
        textarea { width: 100%; height: 100px; padding: 10px; border: none; background: transparent; resize: none; outline: none; font-size: 1rem; line-height: 1.5; }
        .key-input { width: 100%; max-width: 300px; padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.8rem; margin-bottom: 10px; }

        /* æ—¥å†æ ·å¼ */
        .calendar-wrapper { user-select: none; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 0.8rem; color: #94a3b8; padding: 10px 0; font-weight: 600; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { background: #fff; border: 1px solid var(--border); border-radius: 10px; min-height: 90px; padding: 6px; display: flex; flex-direction: column; transition: 0.2s; position: relative; }
        .cal-day:hover { border-color: var(--primary); transform: translateY(-2px); z-index: 10; cursor: pointer; }
        .cal-day.today { border: 2px solid var(--primary); background: #eff6ff; }
        .cal-num { font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 4px; }
        .event-tag { background: var(--primary); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.65rem; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* åˆ—è¡¨å±•ç¤º */
        .event-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .event-info { display: flex; flex-direction: column; gap: 4px; }
        .event-time { font-family: monospace; font-weight: bold; color: var(--primary); font-size: 0.9rem; }

        /* æŒ‰é’®æ ·å¼ */
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #94a3b8; }
        .btn-ghost { background: transparent; color: #64748b; }
        .btn-danger { color: var(--danger); background: #fee2e2; padding: 5px 10px; font-size: 0.75rem; }

        /* ç™»å½•å± */
        .login-screen { position: fixed; inset: 0; background: radial-gradient(circle at center, #3b82f6 0%, #1e3a8a 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 24px; width: 90%; max-width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }

        /* åŠ è½½åŠ¨ç”» */
        .loader { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .cal-day { min-height: 60px; padding: 4px; }
            .calendar-header { font-size: 0.7rem; }
            .event-tag { font-size: 0.6rem; padding: 1px 2px; }
        }
    </style>
</head>
<body>

    <!-- ç™»å½•æ¨¡å— -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 style="font-size: 3rem; margin-bottom: 10px;">ğŸ“…</h1>
            <h2 style="color: #1e40af; margin-bottom: 30px;">AI æ™ºèƒ½æ—¥ç¨‹è¡¨</h2>
            <button class="btn btn-primary" style="width: 100%; padding: 14px;" onclick="login()">Google è´¦å·ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="app" class="container" style="display: none;">
        <div class="top-bar">
            <div>
                <h1 style="font-size: 1.2rem;">æˆ‘çš„æ—¥ç¨‹</h1>
                <div id="userInfo" class="user-pill">åŠ è½½ä¸­...</div>
            </div>
            <button class="btn" style="background:rgba(255,255,255,0.2); color:white;" onclick="logout()">é€€å‡º</button>
        </div>

        <!-- AI å½•å…¥ -->
        <section class="card">
            <div class="card-header">
                <h2>âœ¨ æ™ºèƒ½è¯†åˆ«å½•å…¥</h2>
                <input type="password" id="apiKey" class="key-input" placeholder="è¾“å…¥ DeepSeek API Key">
            </div>
            <div class="card-body">
                <div class="ai-box">
                    <textarea id="aiInput" placeholder="ç›´æ¥ç²˜è´´æ–‡æœ¬æˆ–è¾“å…¥ï¼šæ˜å¤©ä¸‹åˆ3ç‚¹åœ¨æ˜Ÿå·´å…‹è§å®¢æˆ·ï¼ŒæŒç»­1å°æ—¶..."></textarea>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span id="aiStatus" style="font-size:0.8rem; color:#64748b;">æ”¯æŒè¯†åˆ«æ—¥æœŸã€æ—¶é—´ã€ä»»åŠ¡å’Œå¤‡æ³¨</span>
                    <button class="btn btn-primary" id="aiBtn" onclick="processAI()">å¼€å§‹æ™ºèƒ½è¯†åˆ«</button>
                </div>
            </div>
        </section>

        <!-- æ—¥å†è§†å›¾ -->
        <section class="card">
            <div class="card-header">
                <h2>ğŸ“… æœˆåº¦è§†å›¾</h2>
                <input type="month" id="monthPicker" onchange="renderAll()" style="border:1px solid var(--border); padding:5px; border-radius:6px;">
            </div>
            <div class="card-body calendar-wrapper">
                <div class="calendar-header">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </section>

        <!-- è¯¦ç»†åˆ—è¡¨ -->
        <section class="card">
            <div class="card-header"><h2>ğŸ“‹ æ—¥ç¨‹æ˜ç»†</h2></div>
            <div class="card-body" id="eventList" style="padding:0">
                <!-- åˆ—è¡¨å†…å®¹ -->
            </div>
        </section>
    </div>

    <script type="module">
        // --- 1. Firebase æ ¸å¿ƒåˆå§‹åŒ– ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCFk4f7bKUHlb3d1Cg1jyS1EM-SPC4pr40",
            authDomain: "myflightlog-1f4cb.firebaseapp.com",
            projectId: "myflightlog-1f4cb",
            storageBucket: "myflightlog-1f4cb.firebasestorage.app",
            messagingSenderId: "181072044112",
            appId: "1:181072044112:web:ca312da2d4780227cef155"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let allEvents = [];

        // --- 2. ç”¨æˆ·ç™»å½•çŠ¶æ€ç›‘å¬ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'flex';
                document.getElementById('userInfo').textContent = user.displayName;
                document.getElementById('monthPicker').value = new Date().toISOString().slice(0, 7);
                
                // æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„ API Key
                if(localStorage.getItem('my_ai_key')) document.getElementById('apiKey').value = localStorage.getItem('my_ai_key');

                // å®æ—¶ç›‘å¬æ•°æ®åº“
                const q = query(collection(db, `users/${user.uid}/events`), orderBy("date", "asc"));
                onSnapshot(q, (snap) => {
                    allEvents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderAll();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app').style.display = 'none';
            }
        });

        window.login = () => signInWithPopup(auth, provider).catch(e => alert("ç™»å½•å¤±è´¥: " + e.message));
        window.logout = () => signOut(auth);

        // --- 3. AI æ™ºèƒ½è¯†åˆ«é€»è¾‘ (DeepSeek) ---
        window.processAI = async () => {
            const text = document.getElementById('aiInput').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!text || !apiKey) return alert("è¯·è¾“å…¥éœ€è¦è¯†åˆ«çš„å†…å®¹å’Œ API Key");
            localStorage.setItem('my_ai_key', apiKey);

            const btn = document.getElementById('aiBtn');
            const status = document.getElementById('aiStatus');
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span>è¯†åˆ«ä¸­...`;

            const today = new Date().toISOString().split('T')[0];
            const prompt = `
                ä½ æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ—¥ç¨‹åŠ©ç†ã€‚è¯·ä»ç”¨æˆ·çš„æ–‡å­—æè¿°ä¸­æå–æ—¥ç¨‹ä¿¡æ¯å¹¶è½¬æ¢ä¸º JSON æ•°ç»„ã€‚
                å½“å‰æ—¥æœŸæ˜¯: ${today}ã€‚
                å¦‚æœæè¿°ä¸­æåˆ°â€œæ˜å¤©â€ã€â€œä¸‹å‘¨â€ç­‰è¯ï¼Œè¯·æ ¹æ®å½“å‰æ—¥æœŸè®¡ç®—å‡ºå…·ä½“æ—¥æœŸã€‚
                JSON æ ¼å¼è¦æ±‚ï¼š
                [
                  {"title": "ä»»åŠ¡åç§°", "date": "YYYY-MM-DD", "time": "HH:MM", "desc": "è¡¥å……è¯´æ˜æˆ–åœ°ç‚¹"}
                ]
                ç”¨æˆ·æè¿°ï¼š${text}
            `;

            try {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {role: "system", content: "ä½ åªè¾“å‡º JSONï¼Œä¸åŒ…å«ä»»ä½•å¤šä½™çš„æ–‡å­—è¯´æ˜ã€‚"},
                            {role: "user", content: prompt}
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                const raw = await res.json();
                const content = JSON.parse(raw.choices[0].message.content);
                const events = Array.isArray(content) ? content : content.events || [content];

                // ä¿å­˜åˆ° Firebase
                for (let ev of events) {
                    await addDoc(collection(db, `users/${currentUser.uid}/events`), {
                        ...ev,
                        timestamp: new Date()
                    });
                }

                document.getElementById('aiInput').value = "";
                status.style.color = "var(--success)";
                status.textContent = "âœ… å·²æˆåŠŸè¯†åˆ«å¹¶æ·»åŠ æ—¥ç¨‹ï¼";
            } catch (e) {
                console.error(e);
                status.style.color = "var(--danger)";
                status.textContent = "âŒ è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– API Keyã€‚";
            } finally {
                btn.disabled = false;
                btn.innerHTML = "å¼€å§‹æ™ºèƒ½è¯†åˆ«";
            }
        };

        // --- 4. ç•Œé¢æ¸²æŸ“ ---
        window.renderAll = () => {
            renderCalendar();
            renderList();
        };

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthVal = document.getElementById('monthPicker').value;
            if(!monthVal) return;
            
            const [y, m] = monthVal.split('-').map(Number);
            const firstDay = new Date(y, m - 1, 1).getDay();
            const daysInMonth = new Date(y, m, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            grid.innerHTML = '';

            // å¡«å……ç©ºç™½
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="cal-day" style="background:transparent;border:none"></div>`;
            }

            // å¡«å……æ—¥æœŸ
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const dayEvents = allEvents.filter(e => e.date === dateStr);

                let eventHtml = dayEvents.map(e => `<div class="event-tag">${e.time || ''} ${e.title}</div>`).join('');
                
                grid.innerHTML += `
                    <div class="cal-day ${isToday ? 'today' : ''}">
                        <div class="cal-num">${d}</div>
                        <div style="overflow-y:auto; flex:1">${eventHtml}</div>
                    </div>`;
            }
        }

        function renderList() {
            const listEl = document.getElementById('eventList');
            const monthVal = document.getElementById('monthPicker').value;
            const filtered = allEvents.filter(e => e.date.startsWith(monthVal));

            if (filtered.length === 0) {
                listEl.innerHTML = `<div style="padding:20px; text-align:center; color:#94a3b8">æœ¬æœˆæš‚æ— è®¡åˆ’</div>`;
                return;
            }

            listEl.innerHTML = filtered.map(e => `
                <div class="event-item">
                    <div class="event-info">
                        <div style="font-weight:bold; color:#1e293b">${e.title}</div>
                        <div style="font-size:0.8rem; color:#64748b">
                            <span class="event-time">${e.date} ${e.time || ''}</span> 
                            ${e.desc ? `Â· ${e.desc}` : ''}
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteItem('${e.id}')">åˆ é™¤</button>
                </div>
            `).join('');
        }

        window.deleteItem = async (id) => {
            if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/events`, id));
            }
        };

    </script>
</body>
</html>
